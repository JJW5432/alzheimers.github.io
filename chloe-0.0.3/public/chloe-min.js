var JSON;JSON||(JSON={}),function(){function str(a,b){var c,d,e,f,g=gap,h,i=b[a];i&&typeof i=="object"&&typeof i.toJSON=="function"&&(i=i.toJSON(a)),typeof rep=="function"&&(i=rep.call(b,a,i));switch(typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";gap+=indent,h=[];if(Object.prototype.toString.apply(i)==="[object Array]"){f=i.length;for(c=0;c<f;c+=1)h[c]=str(c,i)||"null";e=h.length===0?"[]":gap?"[\n"+gap+h.join(",\n"+gap)+"\n"+g+"]":"["+h.join(",")+"]",gap=g;return e}if(rep&&typeof rep=="object"){f=rep.length;for(c=0;c<f;c+=1)typeof rep[c]=="string"&&(d=rep[c],e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e))}else for(d in i)Object.prototype.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e));e=h.length===0?"{}":gap?"{\n"+gap+h.join(",\n"+gap)+"\n"+g+"}":"{"+h.join(",")+"}",gap=g;return e}}function quote(a){escapable.lastIndex=0;return escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return typeof b=="string"?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function f(a){return a<10?"0"+a:a}"use strict",typeof Date.prototype.toJSON!="function"&&(Date.prototype.toJSON=function(a){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;typeof JSON.stringify!="function"&&(JSON.stringify=function(a,b,c){var d;gap="",indent="";if(typeof c=="number")for(d=0;d<c;d+=1)indent+=" ";else typeof c=="string"&&(indent=c);rep=b;if(b&&typeof b!="function"&&(typeof b!="object"||typeof b.length!="number"))throw new Error("JSON.stringify");return str("",{"":a})}),typeof JSON.parse!="function"&&(JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&typeof e=="object")for(c in e)Object.prototype.hasOwnProperty.call(e,c)&&(d=walk(e,c),d!==undefined?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver=="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")})}(),Chloe=function(a){a=a||{},a.host=a.host||"localhost",a.port=a.port||8901;var b=[Chloe.WebSocketTransport,Chloe.XhrTransport,Chloe.JsonpTransport];for(var c=0,d=b.length;c<d;c++)if(b[c].isEnabled()){this.transport=new b[c](a);break}this.channelSubscriptions={}},Chloe.extend=function(a,b){for(var c in a)b[c]=a[c];return b},Chloe.prototype={connect:function(a){var b=this;this.transport.connect(function(c){b.sessionId=c.sessionId,a()}),this.transport.onmessage(function(a){b.handleMessage(Chloe.Message.unpack(a))})},onmessage:function(a){var b=this;this.onmessageCallback=a},onclose:function(a){this.transport.onclose(a)},send:function(a){var b=Chloe.Message.pack(a,this.sessionId);b.send(this.transport)},subscribe:function(a,b){var c=Chloe.Message.channelSubscribe(a,this);this.channelSubscriptions[a]=b,c.send(this.transport)},handleMessage:function(a){var b=this.channelSubscriptions[a.channel];b?b(a.data):this.onmessageCallback&&this.onmessageCallback(a.data)}},Chloe.WebSocketTransport=function(a){this.host=a.host,this.port=a.port,this.socketAttributes={}},Chloe.WebSocketTransport.prototype={connect:function(a){var b=this;this.socket=new WebSocket("ws://"+this.host+":"+this.port+"/chloe/websocket"),this.socket.onopen=a;for(var c in this.socketAttributes)this.socket[c]=this.socketAttributes[c]},onclose:function(a){this.attachToSocket("onclose",a)},onmessage:function(a){this.attachToSocket("onmessage",function(b){a(b.data)})},send:function(a){this.socket.send(a)},attachToSocket:function(a,b){this.socketAttributes[a]=b,this.socket&&(this.socket[a]=this.socketAttributes[a])}},Chloe.WebSocketTransport.isEnabled=function(){return typeof WebSocket=="function"},Chloe.XhrTransport=function(a){this.host=a.host,this.port=a.port,this.protocol="http://",this.callbacks={}},Chloe.XhrTransport.isEnabled=function(a){return"XMLHttpRequest"in window&&this.prototype.makeXhr().withCredentials!=undefined},Chloe.XhrTransport.prototype={makeXhr:function(){return new XMLHttpRequest},url:function(a){return this.protocol+this.host+":"+this.port+"/chloe"+a},connect:function(a){var b=this,c=new Chloe.Message({type:"connect"});c.pack(),this.postRequest(c.packed,function(d){b.sessionId=d.sessionId,b.listenForMessages(),a(c)})},send:function(a){var b=Chloe.Message.unpack(a);b.sessionId=this.sessionId,b.pack(),this.postRequest(b.packed)},onclose:function(a){this.callbacks.onclose=function(){clearTimeout(this.poller),a()}},onmessage:function(a){this.callbacks.onmessage=a},noop:function(){},handleStateChange:function(a,b){var c=b||this.noop,d=this.callbacks.onclose||this.noop;a.onreadystatechange=function(){var b,e;if(a.readyState==4){a.onreadystatechange=this.noop;try{e=a.status}catch(f){}if(e==200){if(a.responseText!==""){var g=JSON.parse(a.responseText);if(g.messages){var h=g.messages;for(var i in h)c(new Chloe.Message(h[i]))}else c(new Chloe.Message(g))}}else d()}}},getRequest:function(a){var b=this.makeXhr(),c=new Chloe.Message({sessionId:this.sessionId,type:"poll"});c.pack(),b.open("GET",this.url("/xhr/"+ +(new Date))+"?data="+escape(c.packed)),this.handleStateChange(b,a),b.send(null)},postRequest:function(a,b){var c=this.makeXhr();c.open("POST",this.url("/xhr")),"setRequestHeader"in c&&c.setRequestHeader("Content-type","application/x-www-form-urlencoded; charset=utf-8"),this.handleStateChange(c,b),c.send("data="+escape(a))},listenForMessages:function(){var a=this,b=this.callbacks.onmessage||this.noop;message=new Chloe.Message({sessionId:this.sessionId,type:"poll"}),this.getRequest(function(c){typeof c!="undefined"&&(c.pack(),b(c.packed)),a.listenForMessages()})}},Chloe.XDomainTransport=function(a){Chloe.XhrTransport.apply(this,[a])},Chloe.XDomainTransport.isEnabled=function(){return"XDomainRequest"in window},Chloe.XDomainTransport.prototype=Chloe.extend(Chloe.XhrTransport.prototype,{makeXhr:function(){return new XDomainRequest}}),Chloe.JsonpTransport=function(a){this.host=a.host,this.port=a.port,this.protocol="http://",this.callbacks={},this.register()},Chloe.JsonpTransport.prototype={connect:function(a){var b=this,c=new Chloe.Message({id:this.id,type:"connect"});this.callbacks.onconnect=function(c){b.sessionId=c.sessionId,b.listenForMessages(),a(c)},c.pack(),c.send(this)},onmessage:function(a){this.callbacks.onmessage=a},onclose:function(a){this.callbacks.onclose=a},send:function(a,b){var c=this,d=document.createElement("script");b=b||{},d.src=this.url(a),d.type="text/javascript",d.onerror=function(){b.onerror&&b.onerror(),c.handleError()},document.body.appendChild(d)},register:function(){this.id=(new Date).getTime(),Chloe.JsonpTransport.connections[this.id]=this},url:function(a){return this.protocol+this.host+":"+this.port+"/chloe/jsonp.js?data="+escape(a)+"ts="+(new Date).getTime()},handleError:function(){},listenForMessages:function(){var a=this,b=new Chloe.Message({id:this.id,sessionId:this.sessionId,type:"poll"});b.send(this,{onerror:function(){a.listenForMessages()}})}},Chloe.JsonpTransport.connections={},Chloe.JsonpTransport.isEnabled=function(){return!0},Chloe.JsonpTransport.response=function(a){var b=new Chloe.Message(a),c=Chloe.JsonpTransport.connections[b.id];b.pack();if(b.type==="connect")c.callbacks.onconnect(b);else if(b.type==="poll")c.callbacks.onmessage(b.packed),c.listenForMessages();else throw new Error("Unknown message type for JsonpTransport.")},Chloe.Message=function(a){this.version=Chloe.Message.version,this.sessionId=a.sessionId,this.id=a.id,this.type=a.type,this.channel=a.channel,this.data=a.data,this.packed=a.packed},Chloe.Message.version=1,Chloe.Message.pack=function(a,b){var c=new Chloe.Message({data:a,type:"message",sessionId:b});c.pack();return c},Chloe.Message.unpack=function(a){var b=new Chloe.Message({packed:a});b.unpack();return b},Chloe.Message.channelSubscribe=function(a,b){var c=new Chloe.Message({type:"channel-subscribe",sessionId:b.sessionId,channel:a});c.pack();return c},Chloe.Message.prototype={pack:function(){this.packed=JSON.stringify({type:this.type,channel:this.channel,data:this.data,version:this.version,id:this.id,sessionId:this.sessionId})},unpack:function(){var a=JSON.parse(this.packed);if(a.version!==this.version)throw new Error("Expected message version "+a.version+" to match "+this.version);this.data=a.data,this.channel=a.channel,this.type=a.type,this.id=a.id,this.sessionId=a.sessionId},send:function(a){this.pack(),a.send(this.packed)}}